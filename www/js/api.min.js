var Api=(function(){function a(){}a.getConversations=function(g,b,d,c,f){var e=[a.DEFAULT_LIMIT];async.eachSeries(e,function(i,h){var j=a.createGetConversationsApiUrl(g,b,i,d,c);var k=$.getJSON(j);k.done(function(o){var n=a.parseGetConversationsApiResponse(o);if(n!=null){var l=0;for(var m=0;m<n.length;m++){l+=n[m].messages.length}if(l>=i){e.push(i+a.LIMIT_INCREMENT)}else{f(n,null)}}else{f(null,"Error decoding VoIP.ms API response. Are your username and password correct?")}h(null,null)});k.fail(function(){f(null,"Error accessing VoIP.ms API. Are you connected to the Internet?");h(null,null)})},function(){})};a.createGetConversationsApiUrl=function(f,i,e,h,d){var c=moment().utc().subtract(h,"day");var g=moment().utc();var j="https://www.voip.ms/api/v1/rest.php?&api_username="+encodeURIComponent(f)+"&api_password="+encodeURIComponent(i)+"&method=getSMS&did="+encodeURIComponent(d)+"&limit="+encodeURIComponent(String(e))+"&from="+encodeURIComponent(c.toISOString().substr(0,10))+"&to="+encodeURIComponent(g.toISOString().substr(0,10));var b='select * from json where url="'+j+'"';return"https://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent(b)+"&format=json&callback=?"};a.parseGetConversationsApiResponse=function(k){try{var h=[];var b=k.query["results"]["json"]["sms"];if(!(b instanceof Array)){b=[b]}for(var e=b.length-1;e>=0;e--){var d=null;for(var c=0;c<h.length;c++){if(h[c].getRemotePhoneNumber()===b[e]["contact"]){d=h[c]}}if(d===null){d=new Conversation();h.push(d)}var g=new Message(parseInt(b[e]["id"]),b[e]["message"],moment(b[e]["date"]),parseInt(b[e]["type"])===0?1:0,b[e]["did"],b[e]["contact"]);d.messages.push(g)}h.sort(function(j,i){if(j.getEndDate().isSame(i.getEndDate())){return 0}else{if(j.getEndDate().isBefore(i.getEndDate())){return 1}else{return -1}}});return h}catch(f){return null}};a.getLocalPhoneNumbers=function(f,c,e){var b=a.createGetLocalPhoneNumbersApiUrl(f,c);var d=$.getJSON(b);d.done(function(h){var g=a.parseGetLocalPhoneNumbersApiResponse(h);if(g!=null){e(g,null)}else{e(null,"Error decoding VoIP.ms API response. Are your username and password correct?")}});d.fail(function(){e(null,"Error accessing VoIP.ms API. Are you connected to the Internet?")})};a.createGetLocalPhoneNumbersApiUrl=function(e,c){var b="https://www.voip.ms/api/v1/rest.php?&api_username="+encodeURIComponent(e)+"&api_password="+encodeURIComponent(c)+"&method=getDIDsInfo";var d='select * from json where url="'+b+'"';return"https://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent(d)+"&format=json&callback=?"};a.parseGetLocalPhoneNumbersApiResponse=function(f){try{var b=[];var d=f.query["results"]["json"]["dids"];if(!(d instanceof Array)){d=[d]}for(var c=0;c<d.length;c++){if(d[c]["sms_available"]){b.push(d[c]["did"])}}return b}catch(e){return null}};a.sendSms=function(i,c,e,d,g,h){var b=a.createSendMessageApiUrl(i,c,e,d,g);var f=$.getJSON(b);f.done(function(j){var k=a.parseSendMessageApiResponse(j);if(k!=null){h(k,null)}else{h(null,"Error decoding VoIP.ms API response. Are your username, password, and selected phone number correct?")}});f.fail(function(){h(null,"Error accessing VoIP.ms API. Are you connected to the Internet?")})};a.createSendMessageApiUrl=function(h,c,e,d,f){var b="https://www.voip.ms/api/v1/rest.php?&api_username="+encodeURIComponent(h)+"&api_password="+encodeURIComponent(c)+"&method=sendSMS&did="+encodeURIComponent(e)+"&dst="+encodeURIComponent(d)+"&message="+encodeURIComponent(f);var g='select * from json where url="'+b+'"';return"https://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent(g)+"&format=json&callback=?"};a.parseSendMessageApiResponse=function(d){try{var b=d.query["results"]["json"]["status"];return b==="success"}catch(c){return null}};a.DEFAULT_LIMIT=10000;a.LIMIT_INCREMENT=1000;return a})();