var conversations;(function(a){var i="conversations";var c="activeConversationPhoneNumber";function b(){try{var m=JSON.parse(window.localStorage.getItem(i));var n=[];for(var k=0;k<m.length;k++){n[k]=Conversation.createConversation(m[k])}return n}catch(l){return[]}}a.get=b;function h(k){window.localStorage.setItem(i,JSON.stringify(k))}a.set=h;function g(){return JSON.parse(window.localStorage.getItem(c))}a.getActiveConversationPhoneNumber=g;function f(k){window.localStorage.setItem(c,JSON.stringify(k))}a.setActiveConversationPhoneNumber=f;function e(k){api.getConversations(settings.getUsername(),settings.getPassword(),settings.getMessagesHistory(),settings.getLocalPhoneNumber(),function(n,m){if(n===null){k(m)}else{var l=conversations.get();async.eachSeries(n,function(u,v){var o=null;var q=false;for(var r=0;r<l.length;r++){if(u.getRemotePhoneNumber()===l[r].getRemotePhoneNumber()){if(u.equals(l[r])){q=true}else{o=l[r]}break}}if(!q){if(o!==null){var w=null;for(var r=o.messages.length-1;r>=0;r--){if(!o.messages[r].unread&&o.messages[r].type===0){w=o.messages[r];break}}var p="";var s=0;for(var r=u.messages.length-1;r>=0;r--){if((w===null||w.date.isBefore(u.messages[r].date))&&u.messages[r].type===0){u.messages[r].unread=true;p=u.messages[r].text+"\n"+p;s++}else{break}}p=p.trim();if(p!==""&&!o.messages[o.messages.length-1].unread){t(p,u.getRemotePhoneNumber(),s)}else{v()}}else{var p="";var s=0;for(var r=u.messages.length-1;r>=0;r--){if(u.messages[r].type===0){u.messages[r].unread=true;p=u.messages[r].text+"\n"+p;s++}else{break}}p=p.trim();if(p!==""){t(p,u.getRemotePhoneNumber(),s)}else{v()}}function t(z,y,x){contacts.getContact(null,y,function(A){ui.notifications.hideStatusBarNotification(d(y));if(A!==null){ui.notifications.showStatusBarNotification(d(y),A.displayName,z,x,JSON.stringify(y));v()}else{ui.notifications.showStatusBarNotification(d(y),y,z,x,JSON.stringify(y));v()}})}}else{v()}},function(){conversations.set(n);k(null)})}})}a.refresh=e;function j(){var l=conversations.get();for(var k=0;k<l.length;k++){l[k].markAllMessagesAsRead()}conversations.set(l)}a.markAllAsRead=j;function d(n){var m=5381;for(var k=0;k<n.length;k++){var l=n.charCodeAt(k);m=((m<<5)+m)+l}return m}})(conversations||(conversations={}));