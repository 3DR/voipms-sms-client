var ui;(function(g){function h(){b.initialize();a.initialize();i.initialize();e.initialize();j.initialize();d.initialize();f.initialize()}g.initialize=h;var j;(function(l){function k(){$("body").on("pagecontainerchange",function(n,o){if(o.toPage.attr("id")==="page-conversation"){$.mobile.silentScroll(o.toPage.height());$("#conversation-message-input").val("")}});$("#conversation-send-message-button").on("click",function(){var n=$("#conversation-message-input");if(n.val().length>160){ui.notifications.showToastNotification("Message exceeds 160 characters.")}else{if(n.val()===""){ui.notifications.showToastNotification("Message is empty.")}else{ui.loading.startLoading();api.sendSms(settings.getUsername(),settings.getPassword(),settings.getLocalPhoneNumber(),conversations.getActiveConversationPhoneNumber(),n.val(),function(p,o){if(p){conversations.refresh(function(){var r=conversations.get();for(var q=0;q<r.length;q++){if(r[q].getRemotePhoneNumber()===conversations.getActiveConversationPhoneNumber()){m(r[q],function(){ui.loading.stopLoading()});break}}})}else{ui.notifications.showToastNotification(o);ui.loading.stopLoading()}})}}})}l.initialize=k;function m(n,q){if(q===void 0){q=null}ui.loading.startLoading();var p=$("#page-conversation-header");var o=$("#conversation-listview");p.empty();o.empty();contacts.getContact(null,n.messages[0].getRemotePhoneNumber(),function(r){if(r!==null&&r.displayName!==null){p.append(r.displayName)}else{p.append(n.messages[0].getRemotePhoneNumber())}for(var t=0;t<n.messages.length;t++){var u=$("<li>");if(n.messages[t].type===1){u.append($("<span>You</span>"))}else{if(n.messages[t].type===0){if(r!==null&&r.displayName!==null){u.append($("<span>"+r.displayName+"</span>"))}else{u.append($("<span>"+n.messages[t].getRemotePhoneNumber()+"</span>"))}}}var s;if(moment(n.messages[t].date).isSame(moment(),"day")){s=moment(n.messages[t].date).format("h:mm A")}else{if(moment(n.messages[t].date).isSame(moment(),"year")){s=moment(n.messages[t].date).format("MMM D")}else{s=moment(n.messages[t].date).format("YY/MM/DD")}}u.append($('<p class="ui-li-aside date-time-container"><span class="date-time">'+s+"</span></p>"));u.append($("<br>"));u.append($('<p class="message-text">'+n.messages[t].text+"</p>"));o.append(u)}o.listview("refresh");ui.loading.stopLoading();$.mobile.silentScroll($("#page-conversation").height());$("#conversation-message-input").val("");if(q!==null){q()}})}l.display=m})(j=g.conversationpage||(g.conversationpage={}));var d;(function(l){function k(){$("body").on("pagecontainerchange",function(o,p){if(p.toPage.attr("id")==="conversations-page"){m();$.mobile.silentScroll(0)}})}l.initialize=k;function n(p){var t=conversations.get();var r=null;var s=null;for(var q=0;q<t.length;q++){if(t[q].getRemotePhoneNumber()===p){r=t[q];s=q;break}}if(r!==null){conversations.setActiveConversationPhoneNumber(r.getRemotePhoneNumber());r.markAllMessagesAsRead();t[s]=r;conversations.set(t);var o=$("#page-conversation");$("body").pagecontainer("change",o);ui.conversationpage.display(r)}}l.showConversation=n;function m(o){if(o===void 0){o=null}ui.loading.startLoading();$("#conversations-listview").css("display","none");conversations.refresh(function(r){var s=conversations.get();if(s!==null){$("#conversations-listview").empty();var p=0;async.eachSeries(s,function(u,t){contacts.getContact(null,u.getRemotePhoneNumber(),function(v){var y=u.messages;var z=$("<li>");var x=$('<a id="conversations-listview-item-'+p+'" data-item-type="conversations-listview-item" data-phone-number="'+u.getRemotePhoneNumber()+'" href="#">');z.append(x);if(v!==null&&v.photos!==null&&v.photos.length>0){$.get(v.photos[0].value,function(){x.append('<img class="thumbnail" src="'+v.photos[0].value+'">');w()}).fail(function(){x.append('<img src="images/placeholder.png">');w()})}else{x.append('<img src="images/placeholder.png">');w()}function w(){if(v!==null&&v.displayName!=null){x.append("<h2>"+v.displayName+"</h2>")}else{x.append("<h2>"+u.getRemotePhoneNumber()+"</h2>")}if(u.messages[u.messages.length-1].type===1){x.append('<p class="back-icon-container"><a href="#" class="back-icon-link ui-btn ui-btn-d ui-nodisc-icon ui-btn-corner-all ui-icon-back ui-btn-icon-notext ui-alt-icon"></a><span class="message-preview-text">'+u.messages[u.messages.length-1].text+"</span></p>")}else{x.append("<p>"+u.messages[u.messages.length-1].text+"</p>")}var C=y[y.length-1].date;var A=$('<p class="ui-li-aside date-time-container">');var E=$('<span class="date-time">');if(C.isSame(moment().utc(),"day")){E.append(C.local().format("h:mm A"))}else{if(C.isSame(moment().utc(),"year")){E.append(C.local().format("MMM D"))}else{E.append(moment(C).local().format("YY/MM/DD"))}}A.append(E);x.append(A);var B=0;for(var D=0;D<y.length;D++){if(y[D].unread){B++}}if(B>0){x.append('<p class="ui-li-count unread-count">'+B+"</p>")}$("#conversations-listview").append(z);p+=1;t()}})},function(){$("#conversations-listview").listview("refresh");q()})}else{q()}function q(){$("#conversations-listview").css("display","");ui.loading.stopLoading();$.mobile.silentScroll(0);$('a[data-item-type="conversations-listview-item"]').on("click",function(){n($(this).attr("data-phone-number"))});if(ui.notifications.notificationClicked){ui.notifications.processNotificationClick()}if(o!==null){o()}}if(r!==null){ui.notifications.showToastNotification(r)}})}l.display=m})(d=g.conversationspage||(g.conversationspage={}));var c;(function(n){var o=false;function l(){return o}n.isLoading=l;function k(){if(!o){$("body").pagecontainer("getActivePage").addClass("ui-disabled");$.mobile.loading("show",{textVisible:true});o=true}}n.startLoading=k;function m(){if(o){$("body").pagecontainer("getActivePage").removeClass("ui-disabled");$.mobile.loading("hide");o=false}}n.stopLoading=m})(c=g.loading||(g.loading={}));var b;(function(l){function k(){$(document).on("menubutton",function(){if(!ui.loading.isLoading()){if($("body").pagecontainer("getActivePage").attr("id")==="conversations-page"){$("#menu").panel("toggle")}}});$(".menu-button").on("click",function(){$("#menu").panel("toggle")});$("#menu-refresh-button").on("click",function(){ui.conversationspage.display()});$("#menu-mark-all-read-button").on("click",function(){conversations.markAllAsRead();ui.conversationspage.display()})}l.initialize=k})(b=g.menu||(g.menu={}));var f;(function(l){function k(){$(document).on("backbutton",function(){if(!ui.loading.isLoading()){history.back()}});$(".button-back").on("click",function(){history.back()});$(".external-link").on("click",function(){var m=$(this).attr("data-link");window.open(m,"_system")})}l.initialize=k})(f=g.main||(g.main={}));var a;(function(l){function k(){$("body").on("pagecontainerchange",function(m,n){if(n.toPage.attr("id")==="new-conversation-page"){$("#new-conversation-recipient-input").val("");$("#new-conversation-message-textarea").val("")}});$("#new-conversation-contacts-button").on("click",function(){window.plugins.ContactChooser.chooseContact(function(m){if(m.phoneNumber===""){ui.notifications.showToastNotification("Selected contact does not have a phone number.")}else{var n=m.phoneNumber;n=n.replace(/[^\d]/g,"");n=n.replace(/^.*(\d{10})$/,"$1");$("#new-conversation-recipient-input").val(n)}})});$("#new-conversation-send-button").on("click",function(){var m=$("#new-conversation-message-textarea");var n=$("#new-conversation-recipient-input").val().replace(/[^\d]/g,"").replace(/^.*(\d{10})$/,"$1");if(n.length!==10){ui.notifications.showToastNotification("Phone number is not valid.")}else{if(m.val().length>160){ui.notifications.showToastNotification("Message exceeds 160 characters.")}else{if(m.val()===""){ui.notifications.showToastNotification("Message is empty.")}else{ui.loading.startLoading();api.sendSms(settings.getUsername(),settings.getPassword(),settings.getLocalPhoneNumber(),n,m.val(),function(p,o){if(p){history.back()}else{ui.notifications.showToastNotification(o)}ui.loading.stopLoading()})}}}})}l.initialize=k})(a=g.newconversationpage||(g.newconversationpage={}));var i;(function(m){m.notificationClicked=false;var q=null;function k(){window.plugin.notification.local.oncancel=function(t,s,r){m.notificationClicked=true;q=JSON.parse(r);if($("body").pagecontainer("getActivePage").attr("id")!=="conversations-page"){history.back()}else{ui.conversationspage.display()}}}m.initialize=k;function o(){ui.conversationspage.showConversation(q);m.notificationClicked=false}m.processNotificationClick=o;function n(u,r,s){if(r===void 0){r="error"}if(s===void 0){s="bottom"}var t=noty({text:u,type:r,layout:s});t.show()}m.showToastNotification=n;function l(v,u,t,s,r){window.plugin.notification.local.add({id:String(v),title:u,message:t,badge:s,json:r,autoCancel:true})}m.showStatusBarNotification=l;function p(r){window.plugin.notification.local.cancel(r)}m.hideStatusBarNotification=p})(i=g.notifications||(g.notifications={}));var e;(function(l){function k(){$("body").on("pagecontainerchange",function(m,n){if(n.toPage.attr("id")==="page-settings"){$("#settings-username-input").val(settings.getUsername());$("#settings-password-input").val(settings.getPassword());$("#settings-phone-number-input").val(settings.getLocalPhoneNumber());$("#settings-history-input").val(String(settings.getMessagesHistory()));$("#settings-poll-rate-input").val(String(settings.getPollRate()))}});$("#settings-phone-numbers-button").on("click",function(){var m=$("#settings-phone-numbers-fieldset");ui.loading.startLoading();api.getLocalPhoneNumbers(settings.getUsername(),settings.getPassword(),function(n,p){if(p===null){if(n.length===0){ui.notifications.showToastNotification("No phone numbers available. Is SMS enabled on the phone number you wish to use?")}else{m.empty();for(var o=0;o<n.length;o++){m.append($('<input id="settings-phone-numbers-radio-button-'+o+'" name="'+n[o]+'" type="radio">'));m.append($('<label for="settings-phone-numbers-radio-button-'+o+'">'+n[o]+"</label>"))}m.children().first().prop("checked",true);$("#settings-phone-numbers-form").trigger("create");ui.loading.stopLoading();$("body").pagecontainer("change","#page-settings-phone-numbers")}}else{ui.loading.stopLoading();ui.notifications.showToastNotification(p)}})});$("#settings-phone-numbers-select-button").on("click",function(){settings.setLocalPhoneNumber($("input:checked","#settings-phone-numbers-fieldset").attr("name"));history.back()});$("#settings-save-button").on("click",function(){var m=$("#settings-history-input");var n=$("#settings-poll-rate-input");if(isNaN(m.val())||parseInt(m.val())<=0||m.val()>90){ui.notifications.showToastNotification("Number of days of SMS history to retrieve must be an integer greater than 0 and less than or equal to 90.")}else{if(isNaN(n.val())||parseInt(n.val())<0){ui.notifications.showToastNotification("SMS poll rate must be an integer greater than or equal to 0.")}else{ui.notifications.showToastNotification("Settings saved.","success");settings.setUsername($("#settings-username-input").val());settings.setPassword($("#settings-password-input").val());settings.setMessagesHistory(m.val());settings.setPollRate(n.val())}}})}l.initialize=k})(e=g.settingspage||(g.settingspage={}))})(ui||(ui={}));