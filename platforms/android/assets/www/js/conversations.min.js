var conversations;(function(a){var h="conversations";var c="activeConversationPhoneNumber";function b(){try{var l=JSON.parse(window.localStorage.getItem(h));var m=[];for(var j=0;j<l.length;j++){m[j]=Conversation.createConversation(l[j])}return m}catch(k){return[]}}a.get=b;function g(j){window.localStorage.setItem(h,JSON.stringify(j))}a.set=g;function i(){var k=conversations.get();for(var j=0;j<k.length;j++){k[j].markAllMessagesAsRead()}conversations.set(conversations)}a.markAllAsRead=i;function d(j){Api.getConversations(settings.getUsername(),settings.getPassword(),settings.getMessagesHistory(),settings.getLocalPhoneNumber(),function(m,l){if(m===null){j(l)}else{var k=Conversations.getConversations();async.eachSeries(m,function(t,u){var n=null;var p=false;for(var q=0;q<k.length;q++){if(t.getRemotePhoneNumber()===k[q].getRemotePhoneNumber()){if(t.equals(k[q])){p=true}else{n=k[q]}break}}if(!p){if(n!==null){var v=null;for(var q=n.messages.length-1;q>=0;q--){if(!n.messages[q].unread&&n.messages[q].type===0){v=n.messages[q];break}}var o="";var r=0;for(var q=t.messages.length-1;q>=0;q--){if((v===null||v.date.isBefore(t.messages[q].date))&&t.messages[q].type===0){t.messages[q].unread=true;o=t.messages[q].text+"\n"+o;r++}else{break}}o=o.trim();if(o!==""&&!n.messages[n.messages.length-1].unread){s(o,t.getRemotePhoneNumber(),r)}else{u()}}else{var o="";var r=0;for(var q=t.messages.length-1;q>=0;q--){if(t.messages[q].type===0){t.messages[q].unread=true;o=t.messages[q].text+"\n"+o;r++}else{break}}o=o.trim();if(o!==""){s(o,t.getRemotePhoneNumber(),r)}else{u()}}function s(y,x,w){contacts.getContact(null,x,function(z){MainInterface.hideStatusBarNotification(Conversations.hash(x));if(z!==null){MainInterface.showStatusBarNotification(Conversations.hash(x),z.displayName,y,w,JSON.stringify(x));u()}else{MainInterface.showStatusBarNotification(Conversations.hash(x),x,y,w,JSON.stringify(x));u()}})}}else{u()}},function(){Conversations.setConversations(m);j(null)})}})}a.refresh=d;function f(){return JSON.parse(window.localStorage.getItem(Conversations.ACTIVE_CONVERSATION_PHONE_NUMBER_KEY))}a.getActiveConversationPhoneNumber=f;function e(j){window.localStorage.setItem(Conversations.ACTIVE_CONVERSATION_PHONE_NUMBER_KEY,JSON.stringify(j))}a.setActiveConversationPhoneNumber=e})(conversations||(conversations={}));