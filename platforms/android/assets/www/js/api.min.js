var api;(function(e){var d=10000;var h=1000;function b(r,m,o,n,q){var p=[d];async.eachSeries(p,function(t,s){var u=e.createGetConversationsApiUrl(r,m,t,o,n);var v=$.getJSON(u);v.done(function(z){var y=e.parseGetConversationsApiResponse(z);if(y!=null){var w=0;for(var x=0;x<y.length;x++){w+=y[x].messages.length}if(w>=t){p.push(t+h)}else{q(y,null)}}else{q(null,"Error decoding VoIP.ms API response. Are your username, password, and selected phone number correct?")}s(null,null)});v.fail(function(){q(null,"Error accessing VoIP.ms API. Are you connected to the Internet?");s(null,null)})},function(){})}e.getConversations=b;function k(q,t,p,s,o){var n=moment().utc().subtract(s,"day");var r=moment().utc();var u="https://www.voip.ms/api/v1/rest.php?&api_username="+encodeURIComponent(q)+"&api_password="+encodeURIComponent(t)+"&method=getSMS&did="+encodeURIComponent(o)+"&limit="+encodeURIComponent(String(p))+"&from="+encodeURIComponent(n.toISOString().substr(0,10))+"&to="+encodeURIComponent(r.toISOString().substr(0,10));var m='select * from json where url="'+u+'"';return"https://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent(m)+"&format=json&callback=?"}e.createGetConversationsApiUrl=k;function g(t){try{var s=[];var m=t.query["results"]["json"]["sms"];if(!(m instanceof Array)){m=[m]}for(var p=m.length-1;p>=0;p--){var o=null;for(var n=0;n<s.length;n++){if(s[n].getRemotePhoneNumber()===m[p]["contact"]){o=s[n]}}if(o===null){o=new Conversation();s.push(o)}var r=new Message(parseInt(m[p]["id"]),m[p]["message"],moment(m[p]["date"]),parseInt(m[p]["type"])===0?1:0,m[p]["did"],m[p]["contact"]);o.messages.push(r)}s.sort(function(v,u){if(v.getEndDate().isSame(u.getEndDate())){return 0}else{if(v.getEndDate().isBefore(u.getEndDate())){return 1}else{return -1}}});return s}catch(q){return null}}e.parseGetConversationsApiResponse=g;function f(q,n,p){var m=e.createGetLocalPhoneNumbersApiUrl(q,n);var o=$.getJSON(m);o.done(function(s){var r=e.parseGetLocalPhoneNumbersApiResponse(s);if(r!=null){p(r,null)}else{p(null,"Error decoding VoIP.ms API response. Are your username, password, and selected phone number correct?")}});o.fail(function(){p(null,"Error accessing VoIP.ms API. Are you connected to the Internet?")})}e.getLocalPhoneNumbers=f;function j(p,n){var m="https://www.voip.ms/api/v1/rest.php?&api_username="+encodeURIComponent(p)+"&api_password="+encodeURIComponent(n)+"&method=getDIDsInfo";var o='select * from json where url="'+m+'"';return"https://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent(o)+"&format=json&callback=?"}e.createGetLocalPhoneNumbersApiUrl=j;function l(q){try{var m=[];var o=q.query["results"]["json"]["dids"];if(!(o instanceof Array)){o=[o]}for(var n=0;n<o.length;n++){if(o[n]["sms_available"]){m.push(o[n]["did"])}}return m}catch(p){return null}}e.parseGetLocalPhoneNumbersApiResponse=l;function i(t,n,p,o,r,s){var m=e.createSendMessageApiUrl(t,n,p,o,r);var q=$.getJSON(m);q.done(function(u){var v=e.parseSendMessageApiResponse(u);if(v!=null){s(v,null)}else{s(null,"Error decoding VoIP.ms API response. Are your username, password, and selected phone number correct?")}});q.fail(function(){s(null,"Error accessing VoIP.ms API. Are you connected to the Internet?")})}e.sendSms=i;function a(s,n,p,o,q){var m="https://www.voip.ms/api/v1/rest.php?&api_username="+encodeURIComponent(s)+"&api_password="+encodeURIComponent(n)+"&method=sendSMS&did="+encodeURIComponent(p)+"&dst="+encodeURIComponent(o)+"&message="+encodeURIComponent(q);var r='select * from json where url="'+m+'"';return"https://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent(r)+"&format=json&callback=?"}e.createSendMessageApiUrl=a;function c(o){try{var m=o.query["results"]["json"]["status"];return m==="success"}catch(n){return null}}e.parseSendMessageApiResponse=c})(api||(api={}));